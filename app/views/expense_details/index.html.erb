<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h4">Detalles del Gasto Común</h1>
    <%= link_to "Volver a gastos comunes",
        community_common_expenses_path(@common_expense.community),
        class: "btn btn-secondary" %>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <% if @expense_details.any? %>
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Concepto</th>
              <th>Importe</th>
              <th>Distribución</th>

              <% if current_user == @common_expense.community.administrator.user %>
                <th class="text-end">Acciones</th>
              <% end %>

            </tr>
          </thead>

          <tbody>
            <% @expense_details.each do |detail| %>
              <tr>

                <!-- CONCEPTO -->
                <td>
                  <div class="p-2 border rounded bg-light">
                    <strong><%= detail.detail %></strong>
                  </div>
                </td>

                <!-- IMPORTE -->
                <td>
                  <div class="p-2 border rounded bg-light">
                    <%= number_to_currency(detail.amount) %>
                  </div>
                </td>

                <!-- DISTRIBUCIÓN -->
                <td>
                  <div class="p-2 border rounded bg-light">
                    <% if detail.expense_details_neighbors.any? %>

                      <table class="table table-sm table-bordered mb-0 align-middle">
                        <thead class="table-light">
                          <tr>
                            <th>Nombre</th>
                            <th>Unidad</th>
                            <th>Monto</th>
                            <th>Estado</th>
                            <th>Comprobante</th> <!-- NUEVA COLUMNA -->
                          </tr>
                        </thead>

                        <tbody>

                          <% visible_neighbors =
                              current_user.neighbor.present? ?
                                detail.expense_details_neighbors
                                      .includes(neighbor: :user)
                                      .where(neighbor_id: current_user.neighbor.id) :
                                detail.expense_details_neighbors
                                      .includes(neighbor: :user) %>

                          <% visible_neighbors.each do |edn| %>

                            <tr>
                              <td><%= edn.neighbor.user.name %></td>
                              <td><%= edn.neighbor.unit %></td>
                              <td><%= number_to_currency(edn.amount_due) %></td>

                              <!-- ESTADO -->
                              <td>

                                <% if edn.paid? %>
                                  <span class="badge bg-success">Pagado</span>

                                <% elsif edn.status == "approved" %>
                                  <span class="badge bg-success">Aprobado</span>

                                <% elsif edn.status == "rejected" %>
                                  <span class="badge bg-danger">Rechazado</span>

                                <% elsif edn.status == "pending_approval" %>
                                  <span class="badge bg-warning text-dark">Pendiente</span>

                                <% else %>
                                  <span class="badge bg-secondary">No pagado</span>
                                <% end %>

                              </td>

                              <!-- COMPROBANTE -->
                              <td>

                                <!-- Ver comprobante (si existe) -->
                                <% if edn.receipt.attached? %>
                                  <%= link_to "Ver", url_for(edn.receipt),
                                        target: "_blank",
                                        class: "btn btn-sm btn-info w-100 mb-2" %>
                                <% end %>

                                <!-- ADMIN: aprobar / rechazar -->
                                <% if edn.receipt.attached? &&
                                      edn.status == "pending_approval" &&
                                      current_user == @common_expense.community.administrator.user %>

                                  <div class="d-flex gap-1">
                                    <%= button_to "Aprobar",
                                                  approve_expense_path(edn),
                                                  method: :patch,
                                                  class: "btn btn-sm btn-success w-50" %>

                                    <%= button_to "Rechazar",
                                                  reject_expense_path(edn),
                                                  method: :patch,
                                                  class: "btn btn-sm btn-danger w-50" %>
                                  </div>

                                <% end %>

                                <!-- VECINO: subir o reenviar comprobante -->
                                <% if current_user.neighbor == edn.neighbor &&
                                      (edn.status == "unpaid" || edn.status == "rejected") %>

                                  <%= form_with model: edn,
                                        url: pay_expense_path(edn),
                                        method: :patch,
                                        local: true,
                                        html: { multipart: true } do |f| %>

                                    <%= f.file_field :receipt,
                                          accept: "image/*,application/pdf",
                                          class: "form-control form-control-sm mb-2",
                                          required: true %>

                                    <%= f.submit (edn.status == "rejected" ? "Reenviar" : "Pagar"),
                                          class: "btn btn-sm #{edn.status == 'rejected' ? 'btn-warning' : 'btn-success'} w-100" %>

                                  <% end %>

                                <% end %>

                              </td>

                            </tr>
                          <% end %>

                        </tbody>
                      </table>

                    <% else %>
                      <span class="text-muted">Sin vecinos asignados</span>
                    <% end %>
                  </div>
                </td>

                <!-- ACCIONES (solo admin) -->
                <% if current_user == @common_expense.community.administrator.user %>
                  <td class="text-end">
                    <% if policy(detail).create? %>
                      <%= link_to "Ver",
                        expense_detail_path(detail),
                        class: "btn btn-sm btn-outline-secondary mb-1" %>
                    <% end %>

                    <% if policy(detail).edit? %>
                      <%= link_to "Editar",
                        edit_expense_detail_path(detail),
                        class: "btn btn-sm btn-outline-primary mb-1" %>
                    <% end %>

                    <% if policy(detail).destroy? %>
                      <%= link_to "Eliminar",
                        expense_detail_path(detail),
                        data: {
                          turbo_method: :delete,
                          turbo_confirm: "¿Seguro que deseas eliminar este detalle?"
                        },
                        class: "btn btn-sm btn-outline-danger mb-1" %>
                    <% end %>
                  </td>
                <% end %>

              </tr>
            <% end %>
          </tbody>
        </table>

      <% else %>
        <p class="text-muted">No hay detalles cargados.</p>
      <% end %>

      <div class="mt-3 d-flex gap-2">
        <% if policy(@common_expense).new? %>
          <%= link_to "Agregar nuevo detalle",
                new_common_expense_expense_detail_path(@common_expense),
                class: "btn btn-primary" %>
        <% end %>
      </div>

    </div>
  </div>
</div>
