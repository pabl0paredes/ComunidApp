<div class="container mt-4 expense-details-show-page">
  <!-- VOLVER -->
  <div class="d-flex justify-content-between mb-3">
    <%= link_to "← Volver al gasto común",
        common_expense_path(@expense_detail.common_expense),
        class: "text-decoration-none text-primary fw-semibold" %>
  </div>
  <!-- TITULO -->
  <h1 class="h4 mb-4">
    Detalle del gasto — <%= @expense_detail.common_expense.community.name %>
  </h1>
  <!-- CARD PRINCIPAL -->
  <div class="card shadow-sm mb-4">
    <div class="card-body d-flex justify-content-between">
      <div>
        <p class="small text-muted mb-1">Concepto</p>
        <h2 class="h6 mb-2"><%= @expense_detail.detail %></h2>
      </div>
      <div>
        <p class="small text-muted mb-1">Importe total</p>
        <p class="fw-bold"><%= number_to_currency(@expense_detail.amount) %></p>
      </div>
    </div>
  </div>
  <!-- TABLA DE DISTRIBUCIÓN -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Nombre</th>
            <th>Unidad</th>
            <th>Importe asignado</th>
            <th>Estado</th>
            <th class="text-end">Comprobante</th>
          </tr>
        </thead>
        <tbody>
          <% assigned = @expense_detail.expense_details_residents.includes(resident: :user) %>
          <% if assigned.any? %>
            <% assigned.each do |edn| %>
              <tr>
                <td><%= edn.resident.user.name %></td>
                <td><%= edn.resident.unit %></td>
                <td><%= number_to_currency(edn.amount_due) %></td>
                <!-- ESTADO -->
                <td>
                  <% if edn.approved? %>
                    <span class="badge bg-success">Aprobado</span>
                  <% elsif edn.rejected? %>
                    <span class="badge bg-danger">Rechazado</span>
                  <% elsif edn.pending? %>
                    <span class="badge" style="background-color:#60a5fa; color:#0d1b2a;">
                      Pendiente
                    <% else %>
                      <span class="badge bg-secondary">Sin comprobante</span>
                    <% end %>
                  </td>
                  <!-- COMPROBANTE + ACCIONES -->
                  <td class="text-end">
                    <!-- Ver comprobante -->
                    <% if edn.receipt.attached? %>
                      <%= link_to url_for(edn.receipt),
                        target: "_blank",
                        class: "text-primary action-icon me-2",
                        title: "Ver comprobante" do %>
                        <i class="bi bi-eye-fill"></i>
                      <% end %>
                    <% end %>
                    <!-- BOTONES ADMIN -->
                    <% if current_user == @expense_detail.common_expense.community.administrator.user &&
                        edn.receipt.attached? &&
                        edn.pending? %>
                    <!-- Aprobar -->
                    <%= button_to approve_expense_path(edn),
                        method: :patch,
                        class: "btn btn-sm btn-outline-primary me-1",
                        title: "Aprobar comprobante" do %>
                      <i class="bi bi-check-circle-fill"></i>
                    <% end %>
                    <!-- Rechazar -->
                    <%= button_to reject_expense_path(edn),
                        method: :patch,
                        class: "btn btn-sm btn-outline-primary",
                        title: "Rechazar comprobante" do %>
                      <i class="bi bi-x-circle-fill"></i>
                    <% end %>
                  <% end %>
                  <!-- SUBIR O REENVIAR COMPROBANTE -->
                  <% if current_user.resident == edn.resident &&
                        (!edn.receipt.attached? || edn.rejected?) %>
                  <%= form_with model: edn,
                          url: pay_expense_path(edn),
                          method: :patch,
                          local: true,
                          html: { multipart: true },
                          class: "mt-2" do |f| %>
                    <%= f.file_field :receipt,
                          class: "form-control form-control-sm mb-2",
                          accept: "image/*,application/pdf",
                          required: true %>
                    <%= f.submit (edn.rejected? ? "Reenviar comprobante" : "Subir comprobante"),
                          class: "btn btn-sm btn-primary w-100" %>
                  <% end %>
                <% end %>
              </td>
            </tr>
          <% end %>
        <% else %>
          <!-- SI NO HAY VECINOS ASIGNADOS -->
          <tr>
            <td colspan="5" class="text-center text-muted py-4">
              Aún no tienes vecinos asignados a este detalle.
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
<!-- BOTONES FINALES (solo admin) -->
<% if current_user == @expense_detail.common_expense.community.administrator.user %>
  <div class="d-flex justify-content-between">
    <!-- Editar -->
    <%= link_to edit_expense_detail_path(@expense_detail),
          class: "btn btn-outline-primary" do %>
      <i class="bi bi-pencil-fill"></i> Editar
    <% end %>
    <!-- Eliminar (gama azulada en vez de rojo) -->
    <%= link_to expense_detail_path(@expense_detail),
          data: { turbo_method: :delete, turbo_confirm: "¿Seguro?" },
          class: "btn btn-outline-primary text-primary" do %>
      <i class="bi bi-trash-fill"></i> Eliminar
    <% end %>
  </div>
<% end %>
</div>
