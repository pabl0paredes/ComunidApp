<div class="container mt-4" data-controller="resident-selector">

  <h1 class="h4 mb-4">Editar Detalle</h1>

  <div class="card shadow-sm">
    <div class="card-body">

      <%= form_with model: @expense_detail, local: true do |f| %>

        <!-- CAMPOS BÁSICOS -->
        <div class="mb-3">
          <%= f.label :detail, "Descripción del gasto", class: "form-label fw-semibold" %>
          <%= f.text_field :detail,
                value: @expense_detail.detail,
                class: "form-control",
                placeholder: "Ej: Reparación de ascensor" %>
        </div>

        <div class="mb-3">
          <%= f.label :amount, "Monto total", class: "form-label fw-semibold" %>
          <%= f.number_field :amount,
                value: @expense_detail.amount,
                class: "form-control",
                step: "0.01",
                placeholder: "Ej: 150000" %>
        </div>

        <!-- ============================================================
             MODO DE ASIGNACIÓN
        ============================================================ -->

        <% all_residents_ids = @expense_detail.common_expense.community.residents.pluck(:id) %>
        <% selected_ids = @expense_detail.resident_ids %>
        <% all_selected = (selected_ids.sort == all_residents_ids.sort) %>

        <div class="mb-3">
          <label class="form-label fw-bold mb-2">Asignar a vecinos</label>

          <div class="mb-2">

            <!-- Asignar a todos -->
            <div class="form-check">
              <%= radio_button_tag :assign_mode,
                    "all",
                    all_selected,
                    id: "assign_mode_all",
                    class: "form-check-input",
                    data: { action: "resident-selector#toggle" } %>

              <%= label_tag :assign_mode_all,
                    "Asignar a todos los vecinos",
                    class: "form-check-label" %>
            </div>

            <!-- Asignación manual -->
            <div class="form-check">
              <%= radio_button_tag :assign_mode,
                    "manual",
                    !all_selected,
                    id: "assign_mode_manual",
                    class: "form-check-input",
                    data: { action: "resident-selector#toggle" } %>

              <%= label_tag :assign_mode_manual,
                    "Seleccionar vecinos manualmente",
                    class: "form-check-label" %>
            </div>
          </div>

          <p class="small text-muted mt-1">
            La distribución se hará según el porcentaje configurado de cada vecino.
          </p>

          <!-- ============================================================
               LISTA DE CARDS (OCULTA SI "ALL" ESTÁ SELECCIONADO)
          ============================================================ -->
          <div class="mt-3 <%= all_selected ? 'd-none' : '' %>"
               data-resident-selector-target="manualList">

            <div class="resident-grid">

              <% @expense_detail.common_expense.community.residents.each do |resident| %>
                <% is_selected = selected_ids.include?(resident.id) %>

                <label class="resident-card shadow-sm <%= 'selected' if is_selected %>"
                       for="resident_<%= resident.id %>">

                  <div class="resident-info">
                    <h6 class="mb-1 fw-bold"><%= resident.user.name %></h6>
                    <p class="mb-0 small text-muted">
                      Unidad: <strong><%= resident.unit %></strong><br>
                      % asignado: <strong><%= resident.common_expense_fraction %>%</strong>
                    </p>
                  </div>

                  <%= check_box_tag "expense_detail[resident_ids][]",
                        resident.id,
                        is_selected,
                        id: "resident_#{resident.id}",
                        class: "resident-checkbox" %>
                </label>

              <% end %>

            </div>
          </div>

        </div>

        <!-- BOTONES -->
        <div class="d-flex gap-2 mt-3">
          <%= f.submit "Actualizar", class: "btn btn-primary px-4" %>

          <%= link_to "Cancelar",
                common_expense_path(@expense_detail.common_expense),
                class: "btn btn-outline-secondary" %>
        </div>

      <% end %>

    </div>
  </div>
</div>
