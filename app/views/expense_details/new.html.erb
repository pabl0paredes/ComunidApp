<div class="container mt-4"
     data-controller="resident-selector">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">Nuevo Detalle de Gasto</h1>
    <%= link_to "Volver",
      common_expense_expense_details_path(@common_expense),
      class: "btn btn-outline-secondary" %>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">

      <% if @expense_detail.errors.any? %>
        <div class="alert alert-danger">
          <h6 class="fw-bold mb-2">Se encontraron errores:</h6>
          <ul class="mb-0">
            <% @expense_detail.errors.full_messages.each do |msg| %>
              <li><%= msg %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <%= form_with model: [@common_expense, @expense_detail], local: true do |f| %>

        <!-- CAMPOS BÁSICOS -->
        <div class="mb-3">
          <%= f.label :detail, "Descripción del gasto", class: "form-label fw-semibold" %>
          <%= f.text_field :detail, class: "form-control", placeholder: "Ej: Reparación de ascensor" %>
        </div>

        <div class="mb-3">
          <%= f.label :amount, "Monto total", class: "form-label fw-semibold" %>
          <%= f.number_field :amount, class: "form-control", step: "0.01", placeholder: "Ej: 150000" %>
        </div>

        <!-- SECCIÓN ASIGNACIÓN -->
        <div class="mb-3">
          <label class="form-label fw-bold">Asignar a vecinos</label>

          <div class="mb-2">
            <div class="form-check">
              <%= radio_button_tag :assign_mode, "all", true,
                    id: "assign_mode_all",
                    class: "form-check-input",
                    data: { action: "resident-selector#toggle" } %>
              <%= label_tag :assign_mode_all,
                    "Asignar a todos los vecinos de la comunidad",
                    class: "form-check-label" %>
            </div>

            <div class="form-check">
              <%= radio_button_tag :assign_mode, "manual", false,
                    id: "assign_mode_manual",
                    class: "form-check-input",
                    data: { action: "resident-selector#toggle" } %>
              <%= label_tag :assign_mode_manual,
                    "Seleccionar vecinos manualmente",
                    class: "form-check-label" %>
            </div>
          </div>

          <p class="small text-muted mt-1">
            Si seleccionás “Asignar a todos los vecinos”, la lista manual se ignorará.
          </p>

          <!-- LISTA DE CARDS (Stimulus controla visibilidad) -->
          <div class="mt-3 d-none"
               data-resident-selector-target="manualList">

            <div class="resident-grid">
              <% @residents.each do |resident| %>

                <label class="resident-card shadow-sm" for="resident_<%= resident.id %>">

                  <div class="resident-info">
                    <h6 class="mb-1 fw-bold"><%= resident.user.name %></h6>

                    <p class="mb-0 small text-muted">
                      Unidad: <strong><%= resident.unit %></strong><br>
                      Porcentaje: <strong><%= resident.common_expense_fraction %> %</strong>
                    </p>
                  </div>

                  <%= check_box_tag "expense_detail[resident_ids][]",
                        resident.id,
                        false,
                        id: "resident_#{resident.id}",
                        class: "resident-checkbox" %>

                </label>

              <% end %>
            </div>

          </div>
        </div>

        <!-- BOTONES -->
        <div class="d-flex gap-2 mt-3">
          <%= f.submit "Crear detalle", class: "btn btn-primary px-4" %>
          <%= link_to "Cancelar",
                common_expense_expense_details_path(@common_expense),
                class: "btn btn-outline-secondary" %>
        </div>

      <% end %>

    </div>
  </div>
</div>
