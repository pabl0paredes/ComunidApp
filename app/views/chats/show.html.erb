<div class="container mt-3">
  <%= link_to "← Volver a chats", community_chats_path(@chat.community), class: "btn btn-secondary mb-3" %>

  <% if @show_chat.is_hidden? %>
    <%= button_to "Mostrar chat", show_chat_path(@show_chat),
        method: :patch,
        params: { show_chat: { is_hidden: false } },
        class: "btn btn-success mb-3" %>
  <% else %>
    <%= button_to "Ocultar chat", show_chat_path(@show_chat),
        method: :patch,
        params: { show_chat: { is_hidden: true } },
        class: "btn btn-warning mb-3" %>
  <% end %>

  <h2><%= @chat.name %></h2>
  <p class="text-muted">Categoría: <%= @chat.category %></p>

  <hr>

  <h4>Mensajes</h4>

  <%= turbo_frame_tag "messages" do %>
    <div id="messages" class="messages-list mb-4" style="max-height: 400px; overflow-y: auto; padding: 10px; background: #f8f9fa; border-radius: 8px;">
      <% if @messages.any? %>
        <%= render @messages %>
      <% else %>
        <p class="text-muted">Todavía no hay mensajes.</p>
      <% end %>
    </div>
  <% end %>

  <hr>

  <h4>Nuevo mensaje</h4>
  <div id="new_message_form">
    <%= render "messages/form", chat: @chat, message: @message %>
  </div>
</div>

<script>
  function scrollToBottom() {
    const container = document.getElementById("messages");
    if (!container) return;

    // Ejecutar después de que el DOM esté listo
    requestAnimationFrame(() => {
      container.scrollTop = container.scrollHeight;
      console.log("Scroll aplicado:", container.scrollTop, container.scrollHeight);
    });
  }

  // Scroll inicial al cargar la página
  document.addEventListener("turbo:load", scrollToBottom);

  // Scroll después de actualizar el frame de mensajes (envío/eliminación)
  const messagesFrame = document.getElementById("messages");
  if (messagesFrame) {
    const frameParent = messagesFrame.closest("turbo-frame");
    if (frameParent) {
      frameParent.addEventListener("turbo:frame-load", scrollToBottom);
    }
  }
</script>

