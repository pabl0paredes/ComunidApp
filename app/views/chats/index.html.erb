<div class="chat-container chat-page">

  <!-- ENCABEZADO SUPERIOR -->
  <div class="chat-header d-flex justify-content-between align-items-center mb-4">
    <div class="header-left">
      <%= link_to "← Volver a Comunidad", @community, class: "back-link text-decoration-none text-secondary small" %>
      <h2 class="fw-bold section-title">Chats de <%= @community.name %></h2>
    </div>

    <%= link_to "➕ Nuevo Chat",
      new_community_chat_path(@community),
      class: "btn btn-primary btn-main shadow-sm" %>
  </div>

  <!-- TABS -->
  <ul class="nav nav-tabs modern-tabs" id="chatTabs" role="tablist">
    <% @categories.each_with_index do |cat, index| %>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link <%= "active" if index == 0 %>"
          id="tab-<%= cat %>"
          data-bs-toggle="tab"
          data-bs-target="#content-<%= cat %>"
          type="button">
          <%= cat %>
        </button>
      </li>
    <% end %>

    <li class="nav-item" role="presentation">
      <button
        class="nav-link"
        id="tab-ocultos"
        data-bs-toggle="tab"
        data-bs-target="#content-ocultos"
        type="button">
        Ocultos
      </button>
    </li>
  </ul>

  <!-- CONTENIDO -->
  <div class="tab-content mt-4">

    <% @categories.each_with_index do |cat, index| %>
      <div
        class="tab-pane fade <%= "show active" if index == 0 %>"
        id="content-<%= cat %>"
        role="tabpanel">

        <p class="text-secondary small mb-3">
          <%= @category_descriptions[cat] %>
        </p>

        <% category_chats = @visible_chats.select { |c| c.category == cat } %>

        <% if category_chats.any? %>
          <div class="chat-cards-container">

            <% category_chats.each do |chat| %>
              <div class="chat-card section-card" data-href="<%= chat_path(chat) %>">

                <div class="chat-card-header">
                  <%= chat.name %>
                  <span class="chat-tag"><%= chat.category %></span>
                </div>

                <% last_message = chat.messages.last %>
                <% if last_message %>
                  <div class="chat-card-body">
                    <small class="text-muted">Último mensaje:</small>
                    <strong><%= last_message.user.name %></strong>:
                    <%= truncate(last_message.content, length: 50) %>
                    <br>
                    <small class="text-muted"><%= last_message.created_at.strftime("%d/%m/%Y %H:%M") %></small>
                  </div>
                <% else %>
                  <div class="chat-card-body text-muted">
                    Sin mensajes todavía
                  </div>
                <% end %>

                <div class="chat-card-actions mt-3">
                  <% if current_user.administrator.present? %>
                    <%= link_to "Editar categoría",
                      edit_chat_path(chat),
                      class: "btn btn-sm btn-outline-primary btn-main-outline me-2" %>

                    <%= link_to "Eliminar",
                      chat_path(chat),
                      method: :delete,
                      data: { confirm: "¿Seguro que querés eliminar este chat completo?" },
                      class: "btn btn-sm delete-chat-btn" %>
                  <% end %>
                </div>

              </div>
            <% end %>

          </div>
        <% else %>
          <p class="text-muted">No hay chats en esta categoría.</p>
        <% end %>

      </div>
    <% end %>

    <!-- OCULTOS -->
    <div class="tab-pane fade" id="content-ocultos" role="tabpanel">

      <% if @hidden_chats.any? %>
        <div class="chat-cards-container">

          <% @hidden_chats.each do |chat| %>
            <div class="chat-card section-card" data-href="<%= chat_path(chat) %>">

              <div class="chat-card-header">
                <%= chat.name %>
                <span class="chat-tag bg-secondary">Oculto</span>
              </div>

              <div class="chat-card-actions mt-3">
                <%= button_to "Mostrar",
                  show_chat_path(current_user.show_chats.find_by(chat: chat)),
                  method: :patch,
                  params: { show_chat: { is_hidden: false } },
                  class: "btn btn-success btn-sm btn-main" %>
              </div>

            </div>
          <% end %>

        </div>
      <% else %>
        <p class="text-muted">No tienes chats ocultos.</p>
      <% end %>

    </div>

  </div>
</div>

<!-- JS para hacer clic en la card -->
<script>
  document.addEventListener("turbo:load", () => {
    document.querySelectorAll(".chat-card").forEach(card => {
      card.addEventListener("click", (e) => {
        // Ignora clicks en botones o links
        if (!e.target.closest("a") && !e.target.closest("button")) {
          window.location.href = card.dataset.href;
        }
      });
    });
  });
</script>
