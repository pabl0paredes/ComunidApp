<!-- ✅ BOTÓN FLOTANTE DRAGGABLE -->
<button id="chatbot-btn" class="btn btn-primary shadow rounded-circle border-0"
  data-user-id="<%= current_user&.id || 'guest' %>"
  style="
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 56px;
    height: 56px;
    z-index: 1050;
    cursor: grab;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
  ">
  <i class="fa-regular fa-comments"></i>
</button>

<!-- ✅ MINI VENTANA DE CHAT (puedes reemplazar contenido luego) -->
<div id="chat-window" class="card shadow border-0"
  style="
    position: fixed;
    bottom: 90px;
    right: 20px;
    width: 300px;
    height: 380px;
    z-index: 1040;
    display: none;
    border-radius: 16px;
    overflow: hidden;
  ">

  <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center border-0">
    <span class="fw-semibold">Asistente</span>
    <button type="button" id="minimize-chat" class="btn btn-sm btn-light rounded-circle">
      <i class="fa-solid fa-minus"></i>
    </button>
  </div>

  <div class="card-body d-flex flex-column p-3 bg-light">
    <div id="chat-messages" class="flex-grow-1 overflow-auto bg-white p-2 rounded-3"
         style="font-size: 15px; color: #555;">
      <small class="text-muted">Aquí aparecerán los mensajes…</small>
    </div>

    <div class="input-group mt-2 shadow-sm rounded-3 overflow-hidden">
      <input type="text" class="form-control border-0" placeholder="Escribe algo…" disabled>
      <button class="btn btn-primary border-0" disabled>
        <i class="fa-solid fa-paper-plane"></i>
      </button>
    </div>
  </div>
</div>


<script>
function initChatbot() {
  const btn = document.getElementById("chatbot-btn");
  const win = document.getElementById("chat-window");
  if (!btn || !win) return;

  if (btn.dataset.chatbotInitialized === "true") return;
  btn.dataset.chatbotInitialized = "true";

  const userId = btn.dataset.userId || "guest";
  const posKeyBtn = `chatbot_position_btn_${userId}`;
  const posKeyWin = `chatbot_position_win_${userId}`;
  const stateKey  = `chatbot_open_${userId}`;

  /* -------------------------
     RESTAURAR ESTADO AL CARGAR
     ------------------------- */
  const savedBtn = localStorage.getItem(posKeyBtn);
  if (savedBtn) {
    const { left } = JSON.parse(savedBtn);
    btn.style.left = `${left}px`;
    btn.style.right = "auto";
  }

  const savedWin = localStorage.getItem(posKeyWin);
  if (savedWin) {
    const { left, bottom, open } = JSON.parse(savedWin);
    win.style.left = `${left}px`;
    win.style.bottom = `${bottom}px`;
    if (open) win.style.display = "block";
  } else {
    // si nunca se guardó, normal
    win.style.display = "none";
  }

  /* ---------------------------------
     DRAG DEL BOTÓN + GUARDAR POSICIÓN
     --------------------------------- */
  let dragging = false;
  let moved = false;
  let offsetX = 0;

  btn.addEventListener("mousedown", (e) => {
    dragging = true;
    moved = false;
    const rect = btn.getBoundingClientRect();
    offsetX = e.clientX - rect.left;
    btn.style.cursor = "grabbing";
  });

  document.addEventListener("mousemove", (e) => {
    if (!dragging) return;
    moved = true;

    let x = e.clientX - offsetX;
    const maxX = window.innerWidth - btn.offsetWidth;

    if (x < 0) x = 0;
    if (x > maxX) x = maxX;

    btn.style.left = `${x}px`;
    btn.style.right = "auto";

    // Guardar posición del botón mientras se mueve
    localStorage.setItem(posKeyBtn, JSON.stringify({ left: x }));

    // Si el chat está abierto, lo movemos relativo y guardamos
    if (win.style.display === "block") {
      const btnRect = btn.getBoundingClientRect();
      const panelRect = win.getBoundingClientRect();

      let left = btnRect.right - panelRect.width;
      if (left < 0) left = 0;
      if (left > window.innerWidth - panelRect.width) left = window.innerWidth - panelRect.width;

      let bottom = window.innerHeight - btnRect.top + 10;
      if (bottom < 0) bottom = 0;
      if (bottom > window.innerHeight - panelRect.height) bottom = window.innerHeight - panelRect.height;

      win.style.left = `${left}px`;
      win.style.bottom = `${bottom}px`;

      // Guardar posición de ventana
      localStorage.setItem(
        posKeyWin,
        JSON.stringify({ left, bottom, open: true })
      );
    }
  });

  document.addEventListener("mouseup", () => {
    if (!dragging) return;
    dragging = false;
    btn.style.cursor = "grab";

    if (moved) {
      btn.dataset.preventClick = "true";
      setTimeout(() => (btn.dataset.preventClick = "false"), 50);
    }
  });

  /* -------------------------
     CLICK: ABRIR / CERRAR CHAT
     ------------------------- */
  btn.addEventListener("click", () => {
    if (btn.dataset.preventClick === "true") return;

    const isOpen = win.style.display === "block";

    if (isOpen) {
      win.style.display = "none";
      localStorage.setItem(stateKey, "closed");

      const saved = localStorage.getItem(posKeyWin);
      if (saved) {
        let pos = JSON.parse(saved);
        pos.open = false;
        localStorage.setItem(posKeyWin, JSON.stringify(pos));
      }
      return;
    }

    // Abrir
    win.style.display = "block";
    localStorage.setItem(stateKey, "open");

    const btnRect = btn.getBoundingClientRect();
    const panelRect = win.getBoundingClientRect();

    let left = btnRect.right - panelRect.width;
    if (left < 0) left = 0;
    if (left > window.innerWidth - panelRect.width) left = window.innerWidth - panelRect.width;

    let bottom = window.innerHeight - btnRect.top + 10;
    if (bottom < 0) bottom = 0;
    if (bottom > window.innerHeight - panelRect.height) bottom = window.innerHeight - panelRect.height;

    win.style.left = `${left}px`;
    win.style.bottom = `${bottom}px`;

    // Guardar posición y estado
    localStorage.setItem(
      posKeyWin,
      JSON.stringify({ left, bottom, open: true })
    );
  });

  /* -------------------------
     MINIMIZAR (cerrar ventana)
     ------------------------- */
  const minimizeBtn = document.getElementById("minimize-chat");
  minimizeBtn?.addEventListener("click", () => {
    win.style.display = "none";
    localStorage.setItem(stateKey, "closed");

    const saved = localStorage.getItem(posKeyWin);
    if (saved) {
      let pos = JSON.parse(saved);
      pos.open = false;
      localStorage.setItem(posKeyWin, JSON.stringify(pos));
    }
  });

  /* -------------------------
     RESIZE → reposicionar y guardar
     ------------------------- */
  window.addEventListener("resize", () => {
    if (win.style.display !== "block") return;

    const btnRect = btn.getBoundingClientRect();
    const panelRect = win.getBoundingClientRect();

    let left = btnRect.left + (btnRect.width / 2) - (panelRect.width / 2);
    if (left < 0) left = 0;
    if (left > window.innerWidth - panelRect.width) left = window.innerWidth - panelRect.width;

    let bottom = window.innerHeight - btnRect.top + 10;
    if (bottom < 0) bottom = 0;
    if (bottom > window.innerHeight - panelRect.height) bottom = window.innerHeight - panelRect.height;

    win.style.left = `${left}px`;
    win.style.bottom = `${bottom}px`;

    localStorage.setItem(
      posKeyWin,
      JSON.stringify({ left, bottom, open: true })
    );
  });
}

document.addEventListener("turbo:load", initChatbot);
document.addEventListener("turbo:render", initChatbot);
document.addEventListener("DOMContentLoaded", initChatbot);
</script>
