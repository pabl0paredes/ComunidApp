<!-- ✅ BOTÓN FLOTANTE DRAGGABLE -->
<button id="chatbot-btn" class="btn btn-primary shadow rounded-circle border-0"
  data-user-id="<%= current_user&.id || 'guest' %>"
  style="
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 56px;
    height: 56px;
    z-index: 1050;
    cursor: grab;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
  ">
  <i class="fa-regular fa-comments"></i>
</button>

<!-- ✅ MINI VENTANA DE CHAT (puedes reemplazar contenido luego) -->
<div id="chat-window" class="card shadow border-0"
  style="
    position: fixed;
    bottom: 90px;
    right: 20px;
    width: 300px;
    height: 380px;
    z-index: 1040;
    display: none;
    border-radius: 16px;
    overflow: hidden;
  ">

  <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center border-0">
    <span class="fw-semibold">Asistente</span>
    <button type="button" id="minimize-chat" class="btn btn-sm btn-light rounded-circle">
      <i class="fa-solid fa-minus"></i>
    </button>
  </div>

  <div class="card-body d-flex flex-column p-3 bg-light">
    <div id="chat-messages" class="flex-grow-1 overflow-auto bg-white p-2 rounded-3"
         style="font-size: 15px; color: #555;">
      <small class="text-muted">Aquí aparecerán los mensajes…</small>
    </div>

    <div class="input-group mt-2 shadow-sm rounded-3 overflow-hidden">
      <input type="text" class="form-control border-0" placeholder="Escribe algo…" disabled>
      <button class="btn btn-primary border-0" disabled>
        <i class="fa-solid fa-paper-plane"></i>
      </button>
    </div>
  </div>
</div>


<script>
  function initChatbot() {
    const btn = document.getElementById("chatbot-btn");
    const win = document.getElementById("chat-window");
    if (!btn || !win) return;

    // Evitar inicializar dos veces con Turbo
    if (btn.dataset.chatbotInitialized === "true") return;
    btn.dataset.chatbotInitialized = "true";

    // --- Drag horizontal del botón ---
    let dragging = false;
    let offsetX = 0;
    let moved = false;

    btn.addEventListener("mousedown", (e) => {
      dragging = true;
      moved = false;
      const rect = btn.getBoundingClientRect();
      offsetX = e.clientX - rect.left;
      btn.style.cursor = "grabbing";
    });

    document.addEventListener("mousemove", (e) => {
      if (!dragging) return;
      moved = true;

      let x = e.clientX - offsetX;
      const maxX = window.innerWidth - btn.offsetWidth;
      if (x < 0) x = 0;
      if (x > maxX) x = maxX;

      btn.style.left = `${x}px`;
      btn.style.right = "auto";      // dejamos de usar right una vez que se mueve

      // Si el chat está abierto, moverlo junto al botón
      if (win.style.display === "block") {
        const btnRect = btn.getBoundingClientRect();
        const panelRect = win.getBoundingClientRect();

        // borde derecho del botón alineado con borde derecho de ventana
        let left = btnRect.right - panelRect.width;

        // clamp horizontal
        if (left < 0) left = 0;
        const maxLeft = window.innerWidth - panelRect.width;
        if (left > maxLeft) left = maxLeft;

        // mantener ventana sobre el botón
        let bottom = window.innerHeight - btnRect.top + 10;
        const maxBottom = window.innerHeight - panelRect.height;
        if (bottom > maxBottom) bottom = maxBottom;
        if (bottom < 0) bottom = 0;

        win.style.left = `${left}px`;
        win.style.bottom = `${bottom}px`;
      }

    });

    document.addEventListener("mouseup", () => {
      if (!dragging) return;
      dragging = false;
      btn.style.cursor = "grab";

      // Si se arrastró, evitamos que el mouseup dispare el click del botón
      if (moved) {
        btn.dataset.preventClick = "true";
        setTimeout(() => {
          btn.dataset.preventClick = "false";
        }, 50);
      }
    });

    // --- Click: toggle ventana arriba del botón ---
    btn.addEventListener("click", () => {
      if (btn.dataset.preventClick === "true") return;

      const isOpen = win.style.display === "block";

      // Si está abierta → la cerramos
      if (isOpen) {
        win.style.display = "none";
        return;
      }

      // Mostrar primero para poder medir tamaño real
      win.style.display = "block";
      win.style.right = "auto";
      win.style.top = "auto";

      const btnRect = btn.getBoundingClientRect();
      const panelRect = win.getBoundingClientRect();

      let left = btnRect.right - panelRect.width;
      let bottom = window.innerHeight - btnRect.top + 10; // 10px sobre el botón

      // Clamp horizontal (no salir del viewport)
      if (left < 0) left = 0;
      const maxLeft = window.innerWidth - panelRect.width;
      if (left > maxLeft) left = maxLeft;

      // Clamp vertical desde abajo (por si es muy alto)
      const maxBottom = window.innerHeight - panelRect.height;
      if (bottom > maxBottom) bottom = maxBottom;
      if (bottom < 0) bottom = 0;

      win.style.left = `${left}px`;
      win.style.bottom = `${bottom}px`;
    });

    // --- Botón minimizar dentro del panel ---
    const minimizeBtn = document.getElementById("minimize-chat");
    if (minimizeBtn) {
      minimizeBtn.addEventListener("click", () => {
        win.style.display = "none";
      });
    }

    // --- Reposicionar en resize manteniendo lógica "encima del botón" ---
    window.addEventListener("resize", () => {
      if (win.style.display !== "block") return;

      const btnRect = btn.getBoundingClientRect();
      const panelRect = win.getBoundingClientRect();

      let left   = btnRect.left + (btnRect.width / 2) - (panelRect.width / 2);
      let bottom = window.innerHeight - btnRect.top + 10;

      if (left < 0) left = 0;
      const maxLeft = window.innerWidth - panelRect.width;
      if (left > maxLeft) left = maxLeft;

      const maxBottom = window.innerHeight - panelRect.height;
      if (bottom > maxBottom) bottom = maxBottom;
      if (bottom < 0) bottom = 0;

      win.style.left = `${left}px`;
      win.style.bottom = `${bottom}px`;
    });
  }

  // Hooks Turbo
  document.addEventListener("turbo:load", initChatbot);
  document.addEventListener("turbo:render", initChatbot);
  document.addEventListener("DOMContentLoaded", initChatbot);

</script>
