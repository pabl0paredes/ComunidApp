<div class="container mt-4 common-expenses-page">

  <!-- Breadcrumb / volver -->
  <div class="mb-3">
    <%= link_to "â† Volver a Comunidad", @community, class: "text-decoration-none text-primary fw-semibold" %>
  </div>

  <!-- TÃ­tulo -->
  <h1 class="h3 mb-4">Gastos Comunes â€“ <%= @community.name %></h1>

  <% if @community.administrator.user == current_user %>

    <!-- =============================== ADMIN =============================== -->

    <div class="d-flex justify-content-end mb-3">
      <%= link_to "Nuevo Gasto ComÃºn",
          new_community_common_expense_path(@community),
          class: "btn btn-primary" %>
    </div>

    <% if @common_expenses.any? %>

      <% @common_expenses.each do |common_expense| %>

        <% all_edns = common_expense.expense_details_neighbors %>
        <% approved = all_edns.count { |e| e.approved? } %>
        <% total = all_edns.count %>
        <% progress = total > 0 ? ((approved.to_f / total) * 100).round : 0 %>

        <!-- CARD ADMIN -->
        <div class="admin-expense-card shadow-sm">

          <div class="aec-header">
            <div>
              <div class="aec-date"><%= common_expense.date.strftime("%d/%m/%Y") %></div>
              <div class="aec-total">Total: <%= number_to_currency(common_expense.total) %></div>
            </div>

            <div class="aec-actions">
              <%= link_to "Detalles",
                common_expense_expense_details_path(common_expense),
                class: "btn btn-sm btn-outline-success" %>

              <% if policy(common_expense).edit? %>
                <%= link_to "Editar",
                    edit_common_expense_path(common_expense),
                    class: "btn btn-sm btn-outline-primary" %>
              <% end %>

              <% if policy(common_expense).destroy? %>
                <%= link_to "Eliminar",
                    common_expense_path(common_expense),
                    data: {
                      turbo_method: :delete,
                      turbo_confirm: "Â¿Seguro que deseas eliminar este gasto comÃºn?"
                    },
                    class: "btn btn-sm btn-outline-danger" %>
              <% end %>
            </div>
          </div>

          <!-- Barra de progreso -->
          <div class="aec-progress-wrapper">
            <div class="aec-progress-bar" style="width: <%= progress %>%"></div>
          </div>

          <div class="aec-progress-label">
            <%= progress %>% aprobado
          </div>
        </div>

      <% end %>

    <% else %>

      <div class="alert alert-info text-center">
        TodavÃ­a no se registraron gastos comunes en esta comunidad.
      </div>

    <% end %>

  <% else %>

    <!-- =============================== VECINO =============================== -->

    <!-- Resumen -->
    <div class="neighbor-summary mb-4">
      <div class="summary-card shadow-sm">
        <div>
          <p class="mb-1 fw-semibold text-primary">ðŸ“Š Tu resumen mensual</p>
          <p class="mb-0 small text-muted">Gastos asignados en este mes</p>
        </div>
        <div class="text-end">
          <div class="fw-bold text-primary">Total asignado: <%= number_to_currency(@total_assigned) %></div>
          <div class="small text-success">Pagado: <%= number_to_currency(@total_paid) %></div>
          <div class="small text-danger">Pendiente: <%= number_to_currency(@total_pending) %></div>
        </div>
      </div>
    </div>

    <% if @common_expenses.any? %>

      <div class="expense-cards">

        <% @common_expenses.each do |ce| %>

          <% amount_for_user = @neighbor_amounts[ce.id] || 0 %>
          <% edns = ce.expense_details_neighbors.where(neighbor: current_user.neighbor) %>

          <% approved_count = edns.count { |e| e.approved? } %>
          <% total_count = edns.count %>
          <% progress = total_count > 0 ? ((approved_count.to_f / total_count) * 100).round : 0 %>

          <!-- CARD CLICKEABLE (Vecino) -->
          <div
            class="expense-card shadow-sm"
            data-controller="click-card"
            data-click-card-url-value="<%= common_expense_expense_details_path(ce) %>"
            data-action="click->click-card#go"
          >
            <div class="card-header-line">
              <span class="date"><%= ce.date.strftime("%d/%m/%Y") %></span>
              <span class="progress-pill"><%= progress %>% completado</span>
            </div>

            <div class="amount mb-2">
              <strong>Tu parte:</strong> <%= number_to_currency(amount_for_user) %>
            </div>

            <!-- BARRA -->
            <div class="progress-container">
              <div class="progress-bar" style="width: <%= progress %>%"></div>
            </div>

          </div>

        <% end %>
      </div>

    <% else %>

      <div class="alert alert-info text-center mx-auto" style="max-width: 400px;">
        TodavÃ­a no tenÃ©s gastos comunes asignados.
      </div>

    <% end %>

  <% end %>

</div>
