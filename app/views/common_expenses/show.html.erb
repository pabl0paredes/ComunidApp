<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3">Detalle del Gasto Común</h1>
    <%= link_to "Volver a la comunidad",
        community_path(@common_expense.community),
        class: "btn btn-secondary" %>
  </div>
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="mb-4 p-3 border rounded bg-light">
        <p class="mb-2">
          <strong>Total:</strong>
          <span class="ms-2"><%= number_to_currency(@common_expense.total) %></span>
        </p>
        <p class="mb-0">
          <strong>Fecha de Registro:</strong>
          <span class="ms-2"><%= l(@common_expense.date) %></span>
        </p>
      </div>
      <h2 class="h5 mb-3">Detalles del Gasto</h2>
      <% if @common_expense.expense_details.any? %>
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Concepto</th>
              <th>Monto</th>
              <th>Distribución por vecino</th>
              <th class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <% @expense_details.each do |detail| %>
              <tr>
                <!-- CONCEPTO -->
                <td>
                  <div class="p-2 border rounded bg-light">
                    <strong><%= detail.detail %></strong>
                  </div>
                </td>
                <!-- MONTO -->
                <td>
                  <div class="p-2 border rounded bg-light">
                    <%= number_to_currency(detail.amount) %>
                  </div>
                </td>
                <!-- VECINOS EN FORMATO EXCEL -->
                <td>
                  <div class="p-2 border rounded bg-light">
                    <% if detail.expense_details_neighbors.any? %>
                      <table class="table table-sm table-bordered mb-0 align-middle">
                        <thead class="table-light">
                          <tr>
                            <th>Nombre</th>
                            <th>Unidad</th>
                            <th>Monto</th>
                            <th>Estado</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% detail.expense_details_neighbors.includes(:neighbor).each do |edn| %>
                            <tr>
                              <td><%= edn.neighbor.user.name %></td>
                              <td><%= edn.neighbor.unit %></td>
                              <td><%= number_to_currency(edn.amount_due) %></td>
                              <td>
                                <span class="badge <%= edn.paid ? 'bg-success' : 'bg-secondary' %>">
                                  <%= edn.paid ? 'Pagado' : 'No pagado' %>
                                </span>
                              </td>
                            </tr>
                          <% end %>
                        </tbody>
                      </table>
                    <% else %>
                      <span class="text-muted">Sin vecinos asignados</span>
                    <% end %>
                  </div>
                </td>
                <!-- ACCIONES -->
                <td class="text-end">
                  <%= link_to "Ver",
      expense_detail_path(detail),
      class: "btn btn-sm btn-outline-secondary mb-1" %>
                  <%= link_to "Editar",
      edit_expense_detail_path(detail),
      class: "btn btn-sm btn-outline-primary mb-1" %>
                  <%= link_to "Eliminar",
      expense_detail_path(detail),
      data: {
        turbo_method: :delete,
        turbo_confirm: "¿Estás seguro de eliminar este detalle? Se eliminará también la distribución a los vecinos."
      },
      class: "btn btn-sm btn-outline-danger mb-1" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <p class="text-muted">No hay detalles asociados a este gasto común.</p>
      <% end %>
      <%= link_to "Agregar detalle",
          new_common_expense_expense_detail_path(@common_expense),
          class: "btn btn-primary mt-2" %>
    </div>
  </div>
  <div class="d-flex gap-2 mt-4">
    <%= link_to "Editar gasto común",
        edit_common_expense_path(@common_expense),
        class: "btn btn-outline-primary" %>
    <%= link_to "Volver a la lista",
        community_common_expenses_path(@common_expense.community),
        class: "btn btn-outline-secondary" %>
    <%= link_to "Eliminar gasto común",
        @common_expense,
        data: { turbo_method: :delete, turbo_confirm: "¿Estás seguro de eliminar este gasto?" },
        class: "btn btn-outline-danger ms-auto" %>
  </div>
</div>
